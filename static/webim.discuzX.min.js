(function(v,t,da){function ra(){return(new Date).getTime()}function aa(c){return sa.call(c)==="[object Function]"}function ea(c){return sa.call(c)==="[object Array]"}function ia(c){return c&&sa.call(c)==="[object Object]"}function ma(c){return(c||"").replace(/^\s+|\s+$/g,"")}function ba(c,f){var h=false;if(ia(f)){c=c||{};for(var i in f){var j=f[i];if(c[i]!=j){h=h||{};h[i]=j}}}return h}function G(c){var f=[];if(c!=null){var h=c.length;if(h==null||typeof c==="string"||aa(c)||c.setInterval)f[0]=c;else for(;h;)f[--h]=
c[h]}return f}function x(){var c=arguments[0]||{},f=1,h=arguments.length,i=false,j;if(typeof c==="boolean"){i=c;c=arguments[1]||{};f=2}if(typeof c!=="object"&&!aa(c))c={};for(;f<h;f++)if((j=arguments[f])!=null)for(var n in j){var s=c[n],u=j[n];if(c!==u)if(i&&u&&typeof u==="object"&&!u.nodeType)c[n]=x(i,s||(u.length!=null?[]:{}),u);else if(u!==da)c[n]=u}return c}function Q(c,f,h){var i,j=0,n=c.length,s=n===da||aa(c);if(h)if(s)for(i in c){if(f.apply(c[i],h)===false)break}else for(;j<n;){if(f.apply(c[j++],
h)===false)break}else if(s)for(i in c){if(f.call(c[i],i,c[i])===false)break}else for(h=c[0];j<n&&f.call(h,j,h)!==false;h=c[++j]);return c}function na(c,f){for(var h=[],i,j=0,n=c.length;j<n;j++){i=f(c[j],j);if(i!=null)h[h.length]=i}return h.concat.apply([],h)}function ta(c){var f=[];if(typeof c=="object"){for(var h in c)f[f.length]=encodeURIComponent(h)+"="+encodeURIComponent(c[h]);return f.join("&").replace(w,"+")}return c}function F(c){c=x(true,c,x(true,{},M,c));var f,h,i=c.context||v,j=c.type.toUpperCase();
if(c.data&&c.processData&&typeof c.data!=="string")c.data=ta(c.data);if(c.cache===false&&j==="GET"){var n=ra(),s=c.url.replace(J,"$1_="+n+"$2");c.url=s+(s===c.url?(oa.test(c.url)?"&":"?")+"_="+n:"")}if(c.data&&j==="GET")c.url+=(oa.test(c.url)?"&":"?")+c.data;var u=false,q=c.xhr();c.username?q.open(j,c.url,c.async,c.username,c.password):q.open(j,c.url,c.async);try{c.data&&q.setRequestHeader("Content-Type",c.contentType);if(c.ifModified){Z[c.url]&&q.setRequestHeader("If-Modified-Since",Z[c.url]);ga[c.url]&&
q.setRequestHeader("If-None-Match",ga[c.url])}q.setRequestHeader("X-Requested-With","XMLHttpRequest");q.setRequestHeader("Accept",c.dataType&&c.accepts[c.dataType]?c.accepts[c.dataType]+", */*":c.accepts._default)}catch(D){}if(c.beforeSend&&c.beforeSend.call(i,q,c)===false){q.abort();return false}var X=function(ca){if(!q||q.readyState===0){if(E){clearInterval(E);E=null}}else if(!u&&q&&(q.readyState===4||ca==="timeout")){u=true;if(E){clearInterval(E);E=null}var A;if(ca==="timeout")A="timeout";else{a:{try{A=
!q.status&&location.protocol==="file:"||q.status>=200&&q.status<300||q.status===304||q.status===1223||q.status===0;break a}catch(ua){}A=false}if(A){if(A=c.ifModified){A=q;var T=c.url,K=A.getResponseHeader("Last-Modified"),ha=A.getResponseHeader("Etag");if(K)Z[T]=K;if(ha)ga[T]=ha;A=A.status===304||A.status===0}A=A?"notmodified":"success"}else A="error";A=A}f=A;if(f==="success")try{A=q;var H=c.dataType;T=c;var R=A.getResponseHeader("content-type"),xa=H==="xml"||!H&&R&&R.indexOf("xml")>=0,fa=xa?A.responseXML:
A.responseText;if(xa&&fa.documentElement.nodeName==="parsererror")throw"parsererror";if(T&&T.dataFilter)fa=T.dataFilter(fa,H);if(typeof fa==="string")if(H==="json")fa=typeof S==="object"&&S.parse?S.parse(fa):(new Function("return "+fa))();h=fa}catch(za){f="parsererror"}if(f==="success"||f==="notmodified")c.success&&c.success.call(i,h,f);else if(c.error)c.error.call(c.context||v,q,f,void 0);c.complete&&c.complete.call(i,q,f);ca&&q.abort();if(c.async)q=null}};if(c.async){var E=setInterval(X,13);c.timeout>
0&&setTimeout(function(){q&&!u&&X("timeout")},c.timeout)}try{q.send(j==="POST"||j==="PUT"?c.data:null)}catch(I){if(c.error)c.error.call(c.context||v,q,null,I)}c.async||X();return q}function z(c){function f(){var K=X.document;E=E||K.getElementsByTagName("head")[0]||K.documentElement;D=K.createElement("script");D.src=c.url;if(Y.async)D.async=c.async;if(c.scriptCharset)D.charset=c.scriptCharset;D.onload=D.onerror=D.onreadystatechange=function(){if(!T&&(!this.readyState||this.readyState==="loaded"||this.readyState===
"complete")){i("error");h()}};E.insertBefore(D,E.firstChild);if(!Y.defaultAsync&&!Y.events){K=K.createElement("script");K.appendChild(t.createTextNode("try{"+(ca?"parent.":"")+q+"()}catch(e){};"));E.insertBefore(K,E.firstChild);E=K=null}}function h(){T=true;v[u]=da;try{delete v[u]}catch(K){}v[q]=da;try{delete v[q]}catch(ha){}D.onload=D.onreadystatechange=null;D.parentNode&&D.parentNode.removeChild(D);I&&I.parentNode&&I.parentNode.removeChild(I);D=I=E=null}function i(K){c.error&&c.error.call(s,K)}
c=x({},va,c);var j="",n=/%20/g,s=c.context||v,u="jsonp"+B++,q=u+"error",D,X=v,E,I,ca=c.async&&!Y.fragmentProxy&&!Y.defaultAsync&&!Y.async;if(typeof c.data=="object"){var A=[];for(var ua in c.data)A[A.length]=encodeURIComponent(ua)+"="+encodeURIComponent(c.data[ua]);j+=A.join("&").replace(n,"+")}else j+=c.data;j=(j?j+"&":"")+(c.jsonp||"callback")+"="+(ca?"parent.":"")+u;c.url+=(/\?/.test(c.url)?"&":"?")+j;var T=false;v[u]=function(K){c.success&&c.success.call(s,K,"success");h()};v[q]=function(){if(!T){i("error");
h()}};c.timeout>0&&setTimeout(function(){if(!T){i("timeout");h();v[u]=ja}},c.timeout);if(c.async&&!Y.defaultAsync&&Y.fragmentProxy)E=I=t.createDocumentFragment();if(ca){j=v.location;if(c.url.slice(0,1)=="/")c.url=j.protocol+"//"+j.host+(j.port?":"+j.port:"")+c.url;else if(!/^https?:\/\//i.test(c.url)){j=j.href;n=/([^?#]+)\//.exec(j);c.url=(n?n[1]:j)+"/"+c.url}I=t.createElement("iframe");I.style.position="absolute";I.style.left="-100px";I.style.top="-100px";I.style.height="1px";I.style.width="1px";
I.style.visibility="hidden";t.body.appendChild(I);X=I.contentWindow}ca?setTimeout(function(){f()},0):f();return da}function ja(){}function r(c,f){this._setting();this.options={jsonp:false,server:null,ticket:null,domain:null,timeout:4E4,url:{send:null}};x(this.options,f)}function wa(c,f,h){if(typeof f!="undefined"){h=h||{};if(f===null){f="";h=x({},h);h.expires=-1}var i="";if(h.expires&&(typeof h.expires=="number"||h.expires.toUTCString)){if(typeof h.expires=="number"){i=new Date;i.setTime(i.getTime()+
h.expires*24*60*60*1E3)}else i=h.expires;i="; expires="+i.toUTCString()}var j=h.path?"; path="+h.path:"",n=h.domain?"; domain="+h.domain:"";h=h.secure?"; secure":"";t.cookie=[c,"=",encodeURIComponent(f),i,j,n,h].join("")}else{f=null;if(t.cookie&&t.cookie!=""){h=t.cookie.split(";");for(i=0;i<h.length;i++){j=ma(h[i]);if(j.substring(0,c.length+1)==c+"="){f=decodeURIComponent(j.substring(c.length+1));break}}}return f}}function N(c,f){if(ka){var h=new Date,i=["[",h.getHours(),":",h.getMinutes(),":",h.getSeconds(),
"-",h.getMilliseconds(),"]"].join("");h=i+f+S.encode(c);v.console&&v.console.log(i,f,c);i=t.getElementById("webim-log")||t.body;v.air&&v.air.trace(h);if(i){var j=t.createElement("P");j.innerHTML=h;i.appendChild(j)}}}function U(c,f){this.options=x({},U.defaults,f);this._init(c,f)}function pa(c){return c&&c.split?c.split(","):ea(c)?c:parseInt(c)?[parseInt(c)]:[]}function $(c,f,h){function i(j,n){this.data=j;this.options=x({},i.defaults,n);aa(this._init)&&this._init()}i.defaults=f;x(i.prototype,V,h);
U[c]=i}var sa=Object.prototype.toString,V={option:function(c,f){var h=c;this.options=this.options||{};if(typeof c=="string"){if(f===da)return this.options[c];h={};h[c]=f}x(this.options,h);return this},bind:function(c,f){var h=this._events=this._events||{};if(aa(f)){h[c]=h[c]||[];h[c].push(f)}return this},trigger:function(c,f){var h=(this._events=this._events||{})[c];if(!h)return this;f=ea(f)?f:G(f);for(var i=0,j=h.length;i<j;i++)h[i].apply(this,f);return this},unbind:function(c,f){var h=this._events=
this._events||{};if(!h[c])return this;if(aa(f)){h=h[c];for(var i=h.length;i--;)if(h[i]===f||h[i]===f._proxy)h.splice(i,1)}else delete h[c];return this},one:function(c,f){if(!aa(f))return this;var h=this,i=f._proxy=fun._proxy||function(){h.unbind(c,i);return f.apply(this,arguments)};h.bind(c,i)}},w=/%20/g,B=ra(),oa=/\?/,J=/(\?|&)_=.*?(&|$)/,M={url:location.href,global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,xhr:function(){return v.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):
new XMLHttpRequest},accepts:{xml:"application/xml, text/xml",html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"}},Z={},ga={},va={url:location.href,timeout:5E3,jsonp:"callback",async:false},Y=v.jsonpSupport={async:typeof t.createElement("script").async=="boolean",events:false,defaultAsync:false,fragmentProxy:false};(function(){var c=navigator.userAgent.toLowerCase();Y.events=!/(opera)(?:.*version)?[ \/]([\w.]+)/.exec(c);
Y.defaultAsync=!!/(webkit)[ \/]([\w.]+)/.exec(c);c=t.createDocumentFragment();var f=t.createElement("script");text="window.jsonpSupport.fragmentProxy = true";try{f.appendChild(t.createTextNode(text))}catch(h){f.text=text}c.appendChild(f)})();var S=function(){function c(i){return h[i]||"\\u00"+Math.floor(i.charCodeAt()/16).toString(16)+(i.charCodeAt()%16).toString(16)}function f(i){switch(Object.prototype.toString.call(i)){case "[object String]":return'"'+i.replace(/[\x00-\x1f\\"]/g,c)+'"';case "[object Array]":for(var j=
[],n=i.length,s=0;s<n;s++)j.push(f(i[s]));return"["+j.join(",")+"]";case "[object Object]":j=[];for(n in i)(s=f(i[n]))&&j.push(f(n)+":"+s);return"{"+j+"}";case "[object Number]":case "[object Boolean]":return String(i);case false:return"null"}return null}var h={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return{encode:f,decode:function(i){i=i.toString();if(!i||!i.length)return null;return(new Function("return "+i))()}}}();x(r.prototype,V,{_setting:function(){this._onPolling=
this._connecting=this.connected=false;this._pollTimer=null;this._failTimes=this._pollingTimes=0},connect:function(c){var f=this;x(f.options,c);if(f._connecting)return f;f._connecting=true;c=f.options;f._onPolling||v.setTimeout(function(){f._startPolling()},300);return f},close:function(){this._pollTimer&&clearTimeout(this._pollTimer);this._setting();return this},_onConnect:function(){this.connected=true;this.trigger("connect","success")},_onClose:function(c){this._setting();this.trigger("close",[c])},
_onData:function(c){this.trigger("data",c)},_onError:function(c){this._setting();this.trigger("error",c)},_startPolling:function(){var c=this.options;this._onPolling=true;this._pollingTimes++;var f={url:c.server,data:{domain:c.domain,ticket:c.ticket},dataType:"json",timeout:c.timeout,cache:false,context:this,success:this._onPollSuccess,error:this._onPollError};if(c.jsonp){x(f,{timeout:c.timeout,dataType:"jsonp",jsonp:"callback"});z(f)}else F(f)},_onPollSuccess:function(c){var f=this;f._onPolling=
false;if(f._connecting)if(!c||!c.status)return f._onError("error data");else{f._pollingTimes==1&&f._onConnect();f._onData(c);f._failTimes=0;f._pollTimer=v.setTimeout(function(){f._startPolling()},200)}},_onPollError:function(c){var f=this;f._onPolling=false;if(f._connecting){f._failTimes++;if(f._pollingTimes==1)f._onError("can not connect.");else if(f._failTimes>1)f._onClose(c);else f._pollTimer=v.setTimeout(function(){f._startPolling()},200)}}});var ka=true;N.enable=function(){ka=true};N.disable=
function(){ka=false};x(U.prototype,V,{_init:function(){var c=this.options,f={presence:"offline",show:"unavailable"};this.request=c.jsonp?z:F;this.data={user:f};this.status=new U.status;this.setting=new U.setting(null,{jsonp:c.jsonp});this.buddy=new U.buddy(null,{active:this.status.get("b"),jsonp:c.jsonp});this.room=new U.room(null,{user:f,jsonp:c.jsonp});this.history=new U.history(null,{user:f,jsonp:c.jsonp});this.connection=new r(null,{jsonp:true});this._initEvents()},user:function(c){x(this.data.user,
c)},_ready:function(c){var f=this;f._unloadFun=v.onbeforeunload;v.onbeforeunload=function(){f._refresh()};f.trigger("ready",[c])},_go:function(){var c=this.data,f=this.history,h=this.buddy,i=this.room;f.option("userInfo",c.user);Q(c.buddies,function(n,s){f.init("unicast",s.id,s.history)});h.handle(c.buddies);Q(c.rooms,function(n,s){f.init("multicast",s.id,s.history)});h=this.setting.get("blocked_rooms");var j=c.rooms;ea(h)&&j&&Q(h,function(n,s){j[s]&&(j[s].blocked=true)});i.handle(j);i.options.ticket=
c.connection.ticket;this.trigger("go",[c]);this.connection.connect(c.connection);if((c=c.new_messages)&&c.length){Q(c,function(n,s){s["new"]=true});this.trigger("message",[c])}},_stop:function(c){v.onbeforeunload=this._unloadFun;this.data.user.presence="offline";this.data.user.show="unavailable";this.buddy.clear();this.trigger("stop",c)},autoOnline:function(){return!this.status.get("o")},_initEvents:function(){function c(j){var n={id:j.from,presence:j.type};if(j.show)n.show=j.show;if(j.nick)n.nick=
j.nick;if(j.status)n.status=j.status;return n}var f=this,h=f.history,i=f.buddy;f.connection.bind("connect",function(){}).bind("data",function(j){f.handle(j)}).bind("error",function(){f._stop("connect error")}).bind("close",function(){f._stop("disconnect")});f.bind("message",function(j){for(var n=[],s=j.length,u=f.data.user.id,q,D,X,E=0;E<s;E++){q=j[E];X=q.type;D=X=="unicast"?q.to==u?q.from:q.to:q.to;q.id=D;if(X=="unicast"&&!q["new"]){D={id:D,presence:"online"};if(q.nick)D.nick=q.nick;n.push(D)}}if(n.length){i.presence(n);
i.complete()}h.handle(j)});f.bind("presence",function(j){i.presence(na(j,c))})},handle:function(c){c.messages&&c.messages.length&&this.trigger("message",[c.messages]);c.presences&&c.presences.length&&this.trigger("presence",[c.presences]);c.statuses&&c.statuses.length&&this.trigger("status",[c.statuses])},sendMsg:function(c){c.ticket=this.data.connection.ticket;this.trigger("sendMsg",[c]);this.request({type:"post",url:this.options.urls.message,cache:false,data:c})},sendStatus:function(c){c.ticket=
this.data.connection.ticket;this.request({type:"post",url:this.options.urls.status,cache:false,data:c})},sendPresence:function(c){c.ticket=this.data.connection.ticket;this.data.user.show=c.show;this.status.set("s",c.show);this.request({type:"post",url:this.options.urls.presence,cache:false,data:c})},online:function(c){var f=this,h=f.status,i=[],j=[],n=h.get("tabs"),s=h.get("tabIds");s&&s.length&&n&&Q(n,function(u){u[0]=="b"&&i.push(u.slice(2));u[0]=="r"&&j.push(u.slice(2))});c=x({buddy_ids:i.join(","),
room_ids:j.join(","),show:h.get("s")||"available"},c);f._ready(c);h.set("o",false);h.set("s",c.show);f.request({type:"post",dataType:"json",data:c,url:f.options.urls.online,success:function(u){if(!u||!u.user||!u.connection)f._stop("online error");else{u.user=x(f.data.user,u.user,{presence:"online"});f.data=u;f._go()}},error:function(){f._stop("online error")}})},offline:function(){var c=this.data;this.status.set("o",true);this.connection.close();this._stop("offline");this.request({type:"post",url:this.options.urls.offline,
type:"post",cache:false,data:{status:"offline",ticket:c.connection.ticket}})},_refresh:function(){var c=this.data;!c||!c.connection||!c.connection.ticket||this.request({type:"post",url:this.options.urls.refresh,type:"post",cache:false,data:{ticket:c.connection.ticket}})}});v.webim=U;x(U,{version:"1.0.1",defaults:{urls:{online:"webim/online",offline:"webim/offline",message:"webim/message",presence:"webim/presence",refresh:"webim/refresh",status:"webim/status"}},log:N,idsArray:pa,now:ra,isFunction:aa,
isArray:ea,isObject:ia,trim:ma,makeArray:G,extend:x,each:Q,inArray:function(c,f){for(var h=0,i=f.length;h<i;h++)if(f[h]===c)return h;return-1},grep:function(c,f,h){for(var i=[],j=0,n=c.length;j<n;j++)!h!==!f(c[j],j)&&i.push(c[j]);return i},map:na,JSON:S,ajax:F,jsonp:z,comet:r,model:$,objectExtend:V});$("setting",{url:"/webim/setting",data:{blocked_rooms:[],play_sound:true,buddy_sticky:true,minimize_layout:true,msg_auto_pop:true}},{_init:function(){this.request=this.options.jsonp?z:F;this.data=x({},
this.options.data,this.data)},get:function(c){return this.data[c]},set:function(c,f){var h=this,i=c;if(c){if(typeof c=="string"){i={};i[c]=f}var j=h.data,n=ba(j,i);if(n){Q(n,function(s,u){h.trigger("update",[s,u])});i=x({},j,i);h.data=i;h.request({type:"post",url:h.options.url,dataType:"json",cache:false,data:{data:S.encode(i)}})}}}});$("status",{key:"_webim"},{_init:function(){var c=this.data;if(c)this._save(c);else this.data=(c=wa(this.options.key))?S.decode(c):{}},set:function(c,f){var h=c;if(typeof c==
"string"){h={};h[c]=f}var i=this.data;ba(i,h)&&this._save(x({},i,h))},get:function(c){return this.data[c]},clear:function(){this._save({})},_save:function(c){this.data=c;wa(this.options.key,S.encode(c),{path:"/",domain:t.domain})}});$("buddy",{url:"/webim/buddy"},{_init:function(){this.request=this.options.jsonp?z:F;this.data=this.data||[];this.dataHash={};this.handle(this.data)},clear:function(){this.data=[];this.dataHash={}},count:function(c){var f=this.dataHash,h=0,i;for(var j in f)if(ia(c)){i=
true;for(var n in c)if(c[n]!=f[j][n])i=false;i&&h++}else h++;return h},get:function(c){return this.dataHash[c]},complete:function(){var c=this.dataHash,f=[],h;for(var i in c){h=c[i];if(h.incomplete&&h.presence=="online"){h.incomplete=false;f.push(i)}}this.load(f)},update:function(c){this.load(c)},presence:function(c){var f=this.dataHash;c=ea(c)?c:[c];for(var h in c){var i=c[h];i.presence=i.presence=="offline"?"offline":"online";i.incomplete=!f[i.id]}this.handle(c)},load:function(c){c=pa(c);c.length&&
this.request({type:"get",url:this.options.url,async:true,cache:false,dataType:"json",data:{ids:c.join(",")},context:this,success:this.handle})},handle:function(c){var f=this.data,h=this.dataHash,i={};c=c||[];var j,n;for(var s in c){j=c[s];if(id=j.id){if(!h[id]){j.presence=j.presence||"online";j.show=j.show?j.show:j.presence=="offline"?"unavailable":"available";h[id]={};f.push(h[id])}j.incomplete=!!j.incomplete;if(n=ba(h[id],j)){j=n.presence||"update";i[j]=i[j]||[];x(h[id],n);i[j].push(h[id])}}}for(var u in i)this.trigger(u,
[i[u]]);this.options.active&&this.complete()}});(function(){$("room",{urls:{join:"/webim/join",leave:"/webim/leave",member:"/webim/members"}},{_init:function(){this.data=this.data||[];this.dataHash={};this.request=this.options.jsonp?z:F},get:function(c){return this.dataHash[c]},block:function(c){var f=this.dataHash[c];if(f&&!f.blocked){f.blocked=true;var h=[];Q(this.dataHash,function(i,j){j.blocked&&h.push(j.id)});this.trigger("block",[c,h])}},unblock:function(c){var f=this.dataHash[c];if(f&&f.blocked){f.blocked=
false;var h=[];Q(this.dataHash,function(i,j){j.blocked&&h.push(j.id)});this.trigger("unblock",[c,h])}},handle:function(c){var f=this,h=f.data,i=f.dataHash;Q(c,function(j,n){var s=n.id;if(s){n.members=n.members||[];n.count=n.count||0;n.all_count=n.all_count||0;if(i[s])x(i[s],n);else{i[s]=n;h.push(n)}f.trigger("join",[i[s]])}})},addMember:function(c,f){var h=this;if(ea(f))Q(f,function(u,q){h.addMember(c,q)});else{var i=h.dataHash[c];if(i){for(var j=i.members,n,s=j.length;s--;)if(j[s].id==f.id)n=j[s];
if(!n){f.nick=f.nick;j.push(f);i.count=j.length;h.trigger("addMember",[c,f])}}}},removeMember:function(c,f){var h=this.dataHash[c];if(h){for(var i=h.members,j,n=i.length;n--;)if(i[n].id==f){j=i[n];i.splice(n,1);h.count--}j&&self.trigger("removeMember",[c,j])}},initMember:function(c){var f=this.dataHash[c];if(f&&!f.initMember){f.initMember=true;this.loadMember(c)}},loadMember:function(c){var f=this,h=f.options;f.request({type:"get",async:true,cache:false,url:h.urls.member,dataType:"json",data:{ticket:h.ticket,
id:c},success:function(i){f.addMember(c,i)}})},join:function(c){var f=this,h=f.options;f.request({cache:false,type:"post",async:true,url:h.urls.join,dataType:"json",data:{ticket:h.ticket,id:c,nick:h.user.nick},success:function(i){f.initMember(c);f.handle([i])}})},leave:function(c){var f=this.options,h=this.dataHash[c],i=f.user;if(h){h.initMember=false;this.request({cache:false,type:"post",url:f.urls.leave,data:{ticket:f.ticket,id:c,nick:i.nick}});this.trigger("leave",[h])}},clear:function(){}})})();
$("history",{urls:{load:"webim/history",clear:"webim/clear_history"}},{_init:function(){this.data=this.data||{};this.data.unicast=this.data.unicast||{};this.data.multicast=this.data.multicast||{};this.request=this.options.jsonp?z:F},unicast:function(c){return this.data.unicast[c]},multicast:function(c){return this.data.multicast[c]},handle:function(c){var f=this.data,h={unicast:{},multicast:{}};c=G(c);var i=c.length,j,n,s=this.options.userInfo.id;if(i){for(var u=0;u<i;u++){j=c[u];q=j.type;if((n=q==
"unicast"?j.to==s?j.from:j.to:j.to)&&q){h[q][n]=h[q][n]||[];h[q][n].push(j)}}for(var q in h)for(n in h[q]){j=h[q][n];if(f[q][n]){f[q][n]=f[q][n].concat(j);this._triggerMsg(q,n,j)}else this.load(q,n)}}},_triggerMsg:function(c,f,h){this.trigger(c,[f,h])},clear:function(c,f){var h=this.options;this.data[c][f]=[];this.trigger("clear",[c,f]);this.request({url:h.urls.clear,type:"post",cache:false,data:{type:c,id:f}})},init:function(c,f,h){if(ea(h)){this.data[c][f]=h;this._triggerMsg(c,f,h)}},load:function(c,
f){var h=this,i=h.options;h.data[c][f]=[];h.request({url:i.urls.load,async:true,cache:false,type:"get",dataType:"json",data:{type:c,id:f},success:function(j){h.init(c,f,j)}})}})})(window,document);
(function(v,t,da){function ra(){return false}function aa(a){var b="";if(a.length==0)return"";b=a.replace(/&/g,"&gt;");b=b.replace(/</g,"&lt;");b=b.replace(/>/g,"&gt;");b=b.replace(/    /g,"&nbsp;");b=b.replace(/\'/g,"&#39;");b=b.replace(/\"/g,"&quot;");return b=b.replace(/\n/g,"<br />")}function ea(a){return/^http:\/\/[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"])*$/.test(a)}function ia(a){return a?a.replace(/<(?:.|\s)*?>/g,""):""}function ma(a,b){for(var d=[];a;a=a.nextSibling)a.nodeType==
1&&a!=b&&d.push(a);return d}function ba(a,b){return a&&RegExp("(^|\\s+)"+b+"(\\s+|$)").test(a.className)}function G(a,b){if(a)ba(a,b)||(a.className+=" "+b)}function x(a,b){a&&(a.className=a.className.replace(RegExp("(^|\\s+)("+b.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," "))}function Q(a,b,d){a&&(a.className=a.className.replace(RegExp("(^|\\s+)("+b.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," ")+" "+d)}function na(a,b,d){r(a,"mouseover",function(){G(this,b);d&&x(this,d)});r(a,"mouseout",function(){x(this,
b);d&&G(this,d)})}function ta(a,b,d){if(typeof d==="boolean")d?G(a,b):x(a,b);else ba(a,b)?x(a,b):G(a,b)}function F(a){a&&a.style&&(a.style.display="block")}function z(a){a&&a.style&&(a.style.display="none")}function ja(a){a&&a.parentNode&&a.parentNode.removeChild(a)}function r(a,b,d){if(a.addEventListener)a.addEventListener(b,d,false);else{a["e"+b+d]=d;a[b+d]=function(){return a["e"+b+d](v.event)};a.attachEvent("on"+b,a[b+d])}}function wa(a){if(a){a.stopPropagation&&a.stopPropagation();a.cancelBubble=
true}}function N(a){if(a){a.preventDefault&&a.preventDefault();a.returnValue=false}}function U(a){if(!a.target)a.target=a.srcElement||t;if(a.target.nodeType===3)a.target=a.target.parentNode;return a.target}function pa(a){a.setAttribute("unselectable","on");a.style.MozUserSelect="none";r(a,"selectstart",ra)}function $(){if(!E){E=true;if(I){for(var a,b=0;a=I[b++];)a();I=null}}}function sa(){if(!ca){ca=true;if(t.readyState==="complete")return $();if(t.addEventListener)t.addEventListener("DOMContentLoaded",
function(){t.removeEventListener("DOMContentLoaded",arguments.callee,false);$()},false);else if(t.attachEvent){t.attachEvent("onreadystatechange",function(){if(t.readyState==="complete"){t.detachEvent("onreadystatechange",arguments.callee);$()}});t.documentElement.doScroll&&v==v.top&&function(){if(!E){try{t.documentElement.doScroll("left")}catch(a){setTimeout(arguments.callee,0);return}$()}}()}r(v,"load",$)}}function V(a){var b=new Date;b.setTime(a?parseFloat(a)+V.timeSkew:(new Date).getTime());this.date=
b}function w(a,b,d){d=i({locale:w.locale},d);d=w.dictionary[d.locale];c(d)||(d={});a=d[a]===da?a:d[a];if(b){T=b;for(var e in b)a=a.replace(/\{\{(.*?)\}\}/g,K)}return a}function B(a,b){this.element=a;this.options=i({},B.defaults,b);this._init()}function oa(a){a=a.getElementsByTagName("*");for(var b,d,e={},g=a.length-1;g>-1;g--){b=a[g];if((d=b.id)&&d.indexOf(":")==0)e[d.substring(1,d.length)]=b}return e}function J(a){var b=t.createElement("div");b.innerHTML=a;return b=b.firstChild}function M(a,b,d){function e(g,
k){this.id=xa++;this.name=a;this.className="webim-"+a;this.options=i({},e.defaults,k);if(this.element=g||this.template&&J(this.template())||this.options.template&&J(H(this.options.template))){this.options.className&&G(this.element,this.options.className);this.$=oa(this.element)}S(this._init)&&this._init();S(this._initEvents)&&this._initEvents()}e.defaults=b;i(e.prototype,D,M.prototype,d);B[a]=e}function Z(a,b){B.apps[a]=b||{}}function ga(a,b){return b?a=="b"||a=="buddy"||a=="unicast"?"b_"+b:"r_"+
b:a}function va(){t.selection&&(this.caretPos=t.selection.createRange())}var Y=webim.idsArray,S=webim.isFunction,ka=webim.isArray,c=webim.isObject,f=webim.trim,h=webim.makeArray,i=webim.extend,j=webim.each,n=webim.grep,s=webim.ajax,u=webim.jsonp,q=webim.model,D=webim.objectExtend,X=webim.map,E=false,I=[],ca=false;V.timeSkew=0;V.init=function(a){V.timeSkew=(new Date).getTime()-parseFloat(a)};i(V.prototype,{getTime:function(){var a=this.date,b=a.getHours();a=a.getMinutes();if(a<10)a="0"+a;return b+
":"+a+""},getDay:function(a){var b=this.date;if(a){a=new Date;a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);a=a.getTime()-b.getTime();if(a<=0)return w("dt:today");else if(a<864E5)return w("dt:yesterday")}return w("dt:monthdate",{month:w(["dt:january","dt:february","dt:march","dt:april","dt:may","dt:june","dt:july","dt:august","dt:september","dt:october","dt:november","dt:december"][b.getMonth()]),date:b.getDate()})}});var A=function(){var a=true,b={lib:"sound.swf",msg:"sound/msg.mp3"};
return{enable:function(){a=true},disable:function(){a=false},init:function(d){i(b,d);d=b.lib+"?_"+(new Date).getTime();d=navigator.plugins&&navigator.mimeTypes&&navigator.mimeTypes.length?'<embed type="application/x-shockwave-flash" width="10" height="10" id="webim-flashlib" allowscriptaccess="always" src="'+d+'" />':'<object width="10" height="10" id="webim-flashlib" type="application/x-shockwave-flash" data="'+d+'">\t\t\t\t<param name="allowScriptAccess" value="always" />\t\t\t\t<param name="movie" value="'+
d+'" />\t\t\t\t<param name="scale" value="noscale" />\t\t\t\t</object>';try{t.getElementById("webim-flashlib-c").innerHTML=d}catch(e){}},play:function(d){d=ea(d)?d:b[d];if(a)try{t.getElementById("webim-flashlib").playSound(d?d:"/sound/sound.mp3")}catch(e){}}}}(),ua=function(){var a=false;r(v,"focus",function(){a=false});r(v,"blur",function(){a=true});var b=t.title,d=0,e=false;return function(g,k){if(a){if(m){clearInterval(m);d=0;e=false}var m=setInterval(function(){d++;e=!e;if(d==k||!a){clearInterval(m);
d=0;e=false}t.title=e?"["+g+"]"+b:b},1500)}}}(),T={},K=function(a,b){return T[b]||""};w.locale="zh-CN";w.dictionary={};w.store=function(a,b){var d=w.dictionary;c(d[a])||(d[a]={});i(d[a],b)};i(B.prototype,D,{render:function(){var a=this,b=a.layout;a.element.appendChild(b.element);setTimeout(function(){a.initSound()},1E3);b.buildUI()},_init:function(){var a=this.im=new webim(null,this.options.imOptions),b=this.options;b=this.layout=new B.layout(null,i({chatAutoPop:a.setting.get("msg_auto_pop")},b.layoutOptions));
a.setting.get("play_sound")?A.enable():A.disable();a.setting.get("minimize_layout")?b.collapse():b.expand();this._initEvents()},addApp:function(a,b){var d=B.apps[a];if(d){var e=this,g=e.im;S(d.init)&&d.init.apply(e,[b]);S(d.ready)&&g.bind("ready",function(){d.ready.apply(e,arguments)});S(d.go)&&g.bind("go",function(){d.go.apply(e,arguments)});S(d.stop)&&g.bind("stop",function(){d.stop.apply(e,arguments)})}},initSound:function(a){A.init(a||this.options.soundUrls)},_initEvents:function(){var a=this,
b=a.im,d=b.buddy,e=b.history,g=b.setting,k=a.layout,m=b.room;b.bind("ready",function(){k.changeState("ready")}).bind("go",function(l){k.changeState("active");k.option("user",l.user);V.init(l.server_time);a._initStatus()}).bind("stop",function(l){l=="offline"&&k.removeAllChat();k.updateAllChat();k.changeState("stop")});g.bind("update",function(l,o){switch(l){case "play_sound":o?A.enable():A.disable();break;case "msg_auto_pop":k.option("chatAutoPop",o);break;case "minimize_layout":o?k.collapse():k.expand();
break}});d.bind("online",function(l){k.updateChat("buddy",l)}).bind("offline",function(l){k.updateChat("buddy",l)}).bind("update",function(l){k.updateChat("buddy",l)});m.bind("addMember",function(l,o){var p=k.chat("room",l);p&&p.addMember(o.id,o.nick,o.id==b.data.user.id)}).bind("removeMember",function(l,o){var p=k.chat("room",l);p&&p.removeMember(o.id,o.nick)});k.bind("collapse",function(){g.set("minimize_layout",true)});k.bind("expand",function(){g.set("minimize_layout",false)});k.bind("displayUpdate",
function(){a._updateStatus()});b.bind("message",function(l){for(var o=false,p=l.length,y,L=b.data.user.id,O,P,C=0;C<p;C++){y=l[C];O=y.id;type=y.type;(P=k.chat(type,O))&&P.status("");if(!P){y.type==="unicast"?a.addChat(type,O,null,null,y.nick):a.addChat(type,O);P=k.chat(type,O)}P&&g.get("msg_auto_pop")&&!k.activeTabId&&k.focusChat(O);P.window.notifyUser("information","+1");O=P.window.pos;O==-1&&k.setNextMsgNum("+1");O==1&&k.setPrevMsgNum("+1");if(y.from!=L)o=true}if(o){A.play("msg");ua(w("new message"),
5)}});b.bind("status",function(l){j(l,function(o,p){var y=b.data.user.id,L=p.from;if(!(y!=p.to&&y!=p.from))(y=k.chat("buddy",L))&&y.status(p.show)})});e.bind("unicast",function(l,o){var p=k.chat("unicast",l);p&&p.history.add(o)});e.bind("multicast",function(l,o){var p=k.chat("multicast",l);p&&p.history.add(o)});e.bind("clear",function(l,o){var p=k.chat(l,o);p&&p.history.clear()})},__status:false,_initStatus:function(){var a=this,b=a.layout;if(a.__status)return b.updateAllChat();a.__status=true;var d=
a.im.status,e=d.get("tabs"),g=d.get("tabIds"),k=d.get("p");d=d.get("a");g&&g.length&&e&&j(e,function(m,l){var o=m.slice(2),p=m.slice(0,1);a.addChat(p,o,{},{isMinimize:true});b.chat(m).window.notifyUser("information",l.n)});k&&(b.prevCount=k)&&b._fitUI();d&&b.focusChat(d)},addChat:function(a,b,d,e,g){a=a=="b"||a=="buddy"||a=="unicast"?"buddy":"room";var k=this,m=k.layout,l=k.im,o=k.im.history,p=l.buddy,y=l.room,L=k.options;if(!m.chat(a,b))if(a=="room"){d=i({},L.roomChatOptions,d);L=o.multicast(b);
var O=y.get(b);g=O||{id:b,nick:g||b};g.presence="online";m.addChat(a,g,i({history:L,block:true,emot:true,clearHistory:false,member:true,msgType:"multicast"},d),e);L||o.load("multicast",b);var P=m.chat(a,b);P.bind("sendMsg",function(C){l.sendMsg(C);o.handle(C)}).bind("select",function(C){p.online(C.id);k.addChat("buddy",C.id,null,null,C.nick);m.focusChat("buddy",C.id)}).bind("block",function(C){y.block(C.id)}).bind("unblock",function(C){y.unblock(C.id)}).window.bind("close",function(){P.options.info.blocked&&
y.leave(b)});setTimeout(function(){P.options.info.blocked?y.join(b):y.initMember(b)},500);ka(g.members)&&j(g.members,function(C,W){P.addMember(W.id,W.nick,W.id==l.data.user.id)})}else{d=i({},L.buddyChatOptions,d);L=o.unicast(b);g=(O=p.get(b))||{id:b,nick:g||b};m.addChat(a,g,i({history:L,block:false,emot:true,clearHistory:true,member:false,msgType:"unicast"},d),e);O||p.update(b);L||o.load("unicast",b);m.chat(a,b).bind("sendMsg",function(C){l.sendMsg(C);o.handle(C)}).bind("sendStatus",function(C){l.sendStatus(C)}).bind("clearHistory",
function(C){o.clear("unicast",C.id)})}},_updateStatus:function(){var a=this.layout,b={};j(a.tabs,function(d,e){b[d]={n:e._count()}});this.im.status.set({tabs:b,tabIds:a.tabIds,p:a.prevCount,a:a.activeTabId})}});var ha=function(a,b){if(b===da)return parseInt(a.innerHTML);else if(b){b=typeof b=="number"?b:parseInt(a.innerHTML)+parseInt(b);a.innerHTML=b.toString();F(a)}else{a.innerHTML="0";z(a)}return b},H=function(){function a(e,g){return b&&b[g]!=da?b[g]:w(g)}var b=null,d=/\<\%\=(.*?)\%\>/ig;return function(e,
g){if(!e)return"";b=g;return e.replace(d,a)}}(),R={add:function(a,b,d){a=B[a].prototype;for(var e in d){a.plugins[e]=a.plugins[e]||[];a.plugins[e].push([b,d[e]])}},call:function(a,b,d){if((b=a.plugins[b])&&a.element.parentNode)for(var e=0;e<b.length;e++)a.options[b[e][0]]&&b[e][1].apply(a.element,d)}},xa=1;i(M.prototype,{_init:function(){}});i(B,{version:"3.0.1",widget:M,app:Z,plugin:R,i18n:w,date:V,ready:function(a){sa();E?a():I.push(a)},createElement:J,defaults:{},apps:{}});webim.ui=B;M("window",
{isMinimize:false,minimizable:true,maximizable:false,closeable:true,sticky:true,titleVisibleLength:12,count:0,template:'<div id=":webim-window" class="webim-window ui-widget">                                            <div class="webim-window-tab-wrap">                                            <div id=":tab" class="webim-window-tab ui-state-default">                                            <div class="webim-window-tab-inner">                                                    <div id=":tabTip" class="webim-window-tab-tip">                                                            <strong id=":tabTipC"><%=tooltip%></strong>                                                    </div>                                                    <a id=":tabClose" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                    <div id=":tabCount" class="webim-window-tab-count">                                                            0                                                    </div>                                                    <em id=":tabIcon" class="webim-icon webim-icon-comments"></em>                                                    <h4 id=":tabTitle"><%=title%></h4>                                            </div>                                            </div>                                            </div>                                            <div><div id=":window" class="webim-window-window">\t\t\t\t\t\t<iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe>                                                    <div id=":header" class="webim-window-header ui-widget-header ui-corner-top">                                                            <span id=":actions" class="webim-window-actions">                                                                    <a id=":minimize" title="<%=minimize%>" class="webim-window-minimize" href="#minimize"><em class="ui-icon ui-icon-minus"><%=minimize%></em></a>                                                                    <a id=":maximize" title="<%=maximize%>" class="webim-window-maximize" href="#maximize"><em class="ui-icon ui-icon-plus"><%=maximize%></em></a>                                                                    <a id=":close" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                            </span>                                                            <h4 id=":headerTitle"><%=title%></h4>                                                            <div id=":subHeader" class="webim-window-subheader"></div>                                                    </div>                                                    <div id=":content" class="webim-window-content ui-widget-content">                                                    </div>                                            </div>                                            </div>                                            </div>'},
{html:function(a){return this.$.content.appendChild(a)},subHeader:function(a){this.$.subHeader.innerHTML="";return this.$.subHeader.appendChild(a)},_init:function(a,b){b=this.options;var d=this.$;a=this.element;a.window=this;b.tabWidth&&(d.tab.style.width=b.tabWidth+"px");b.subHeader&&this.subHeader(b.subHeader);this.title(b.title,b.icon);!b.minimizable&&z(d.minimize);!b.maximizable&&z(d.maximize);if(!b.closeable){z(d.tabClose);z(d.close)}b.isMinimize?this.minimize():this.restore();b.onlyIcon?z(d.tabTitle):
ja(d.tabTip);b.count&&this.notifyUser("information",b.count);fa(this)},notifyUser:function(a,b){var d=this.$;if(a=="information")if(this.isMinimize())if(ha(d.tabCount,b)){G(d.tab,"ui-state-highlight");x(d.tab,"ui-state-default")}},_count:function(){return ha(this.$.tabCount)},title:function(a,b){var d=this.$,e=d.tabIcon;if(b)if(ea(b)){e.className="webim-icon";e.style.backgroundImage="url("+b+")"}else e.className="webim-icon webim-icon-"+b;d.tabTipC.innerHTML=a;e=this.options.titleVisibleLength;if(a){for(var g=
0,k=[],m=a.split(""),l=m.length,o=0;o<l;o++)if(g>=e||g<0)break;else{if(m[o].charCodeAt(0)>255)g+=2;else g++;k.push(m[o])}e=k.join("")}else e=a;(d.tabTitle.innerHTML=e)&&a&&e.length<a.length&&d.tabTitle.setAttribute("title",a);d.headerTitle.innerHTML=a},_changeState:function(a){Q(this.element,"webim-window-normal webim-window-maximize webim-window-minimize","webim-window-"+(a=="restore"?"normal":a));this.trigger("displayStateChange",[a])},active:function(){return ba(this.element,"webim-window-active")},
activate:function(){if(!this.active()){G(this.element,"webim-window-active");this.trigger("activate")}},deactivate:function(){if(this.active()){x(this.element,"webim-window-active");this.options.sticky||this.minimize();this.trigger("deactivate")}},_setVisibile:function(){var a=this.$;Q(a.tab,"ui-state-default ui-state-highlight","ui-state-active");this.activate();ha(a.tabCount,0)},maximize:function(){if(!this.isMaximize()){this._setVisibile();this._changeState("maximize")}},restore:function(){if(!ba(this.element,
"webim-window-normal")){this._setVisibile();this._changeState("restore")}},minimize:function(){if(!this.isMinimize()){Q(this.$.tab,"ui-state-active","ui-state-default");this.deactivate();this._changeState("minimize")}},tabClose:function(){this.close()},close:function(){this.trigger("close");ja(this.element)},_initEvents:function(){var a=this,b=a.$,d=b.tab,e=function(g){wa(g);N(g)};r(d,"click",function(g){a.isMinimize()?a.restore():a.minimize();e(g)});r(d,"mouseover",function(){G(this,"ui-state-hover");
x(this,"ui-state-default")});r(d,"mouseout",function(){x(this,"ui-state-hover");this.className.indexOf("ui-state-")==-1&&G(this,"ui-state-default")});r(d,"mousedown",e);pa(d);j(ma(b.actions.firstChild),function(g,k){na(k,"ui-state-hover")});j(["minimize","maximize","close","tabClose"],function(g,k){r(b[k],"click",function(m){this.disabled||a[k]();e(m)});r(b[k],"mousedown",e)})},height:function(){return this.$.content.offsetHeight},_fitUI:function(){},isMaximize:function(){return ba(this.element,"webim-window-maximize")},
isMinimize:function(){return ba(this.element,"webim-window-minimize")}});var fa=function(){var a=false,b=function(){a&&a.deactivate();a=false;return true},d=function(){this&&this!=a&&b()&&(a=this)},e=function(){this&&a==this&&(a=false)};r(t,"mousedown",function(g){g=U(g);for(var k;g;)if(g.id==":webim-window"){k=g;break}else g=g.parentNode;if(k)(g=k.window)&&g.activate();else b()});return function(g){if(g.active()){b();a=g}g.bind("activate",d);g.bind("deactivate",e)}}();M("layout",{template:'<div id="webim" class="webim webim-state-ready">                    <div class="webim-preload ui-helper-hidden-accessible">                    <div id="webim-flashlib-c">                    </div>                    </div><div id=":layout" class="webim-layout"><iframe class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><div class="webim-layout-bg ui-state-default ui-toolbar"></div><div class="webim-ui ui-helper-clearfix">                            <div id=":shortcut" class="webim-shortcut">                            </div>                            <div class="webim-layout-r">                            <div id=":panels" class="webim-panels">                                <div class="webim-window-tab-wrap ui-widget webim-panels-next-wrap">                                            <div id=":next" class="webim-window-tab webim-panels-next ui-state-default">                                                    <div id=":nextMsgCount" class="webim-window-tab-count">                                                            0                                                    </div>                                                    <em class="ui-icon ui-icon-triangle-1-w"></em>                                                    <span id=":nextCount">0</span>                                            </div>                                </div>                                <div id=":tabsWrap" class="webim-panels-tab-wrap">                                        <div id=":tabs" class="webim-panels-tab">                                        </div>                                </div>                                <div class="webim-window-tab-wrap ui-widget webim-panels-prev-wrap">                                            <div id=":prev" class="webim-window-tab webim-panels-prev ui-state-default">                                                    <div id=":prevMsgCount" class="webim-window-tab-count">                                                            0                                                    </div>                                                    <span id=":prevCount">0</span>                                                    <em class="ui-icon ui-icon-triangle-1-e"></em>                                            </div>                                </div>                                <div class="webim-window-tab-wrap webim-collapse-wrap ui-widget">                                            <div id=":collapse" class="webim-window-tab webim-collapse ui-state-default" title="<%=collapse%>">                                                    <em class="ui-icon ui-icon-circle-arrow-e"></em>                                            </div>                                </div>                                <div class="webim-window-tab-wrap webim-expand-wrap ui-widget">                                            <div id=":expand" class="webim-window-tab webim-expand ui-state-default" title="<%=expand%>">                                                    <em class="ui-icon ui-icon-circle-arrow-w"></em>                                            </div>                                </div>                            </div>                            <div id=":widgets" class="webim-widgets">                            </div>                            </div>            </div></div>                    </div>',
shortcutLength:5,chatAutoPop:true,tpl_shortcut:'<div class="webim-window-tab-wrap ui-widget webim-shortcut-item"><a class="webim-window-tab" href="<%=link%>" target="<%=target%>">                                                    <div class="webim-window-tab-tip">                                                            <strong><%=title%></strong>                                                    </div>                                                    <em class="webim-icon" style="background-image:url(<%=icon%>)"></em>                                            </a>                                            </div>'},
{_init:function(a,b){b=this.options;i(this,{window:v,widgets:{},panels:{},tabWidth:136,maxVisibleTabs:null,animationTime:210,activeTabId:null,tabs:{},tabIds:[],nextCount:0,prevCount:0});b.unscalable&&G(this.$.layout,"webim-layout-unscalable");b.isMinimize&&this.collapse()},changeState:function(a){this.element.className="webim webim-state-"+a},_ready:false,buildUI:function(){var a=this.$;this.maxVisibleTabs=parseInt(((t.compatMode==="CSS1Compat"&&t.documentElement.clientWidth||t.body.clientWidth)-
45-a.shortcut.offsetWidth-a.widgets.offsetWidth-70)/this.tabWidth);this._fitUI();this._ready=true},_updatePrevCount:function(a){var b=this.tabIds,d=this.maxVisibleTabs,e=b.length,g=this.prevCount;if(!(e<=d)){if(a){for(var k=0,m=0;m<e;m++)if(b[m]==a){k=m;break}if(k<=g)g=k;else if(k>=g+d)g=k-d+1}else g=e-d;this.prevCount=g}},_setVisibleTabs:function(a){for(var b=this.prevCount,d=b+this.maxVisibleTabs,e=this.tabs,g=this.tabIds,k=g.length,m=0,l=0,o=0;o<k;o++){var p=e[g[o]];if(o<b||o>=d)if(a)F(p.element);
else{this.activeTabId==g[o]&&p.minimize();var y=p._count();if(o<b){l+=y;p.pos=1}else{m+=y;p.pos=-1}z(p.element)}else{p.pos=0;F(p.element)}}if(!a){this.setNextMsgNum(m);this.setPrevMsgNum(l)}},setNextMsgNum:function(a){ha(this.$.nextMsgCount,a)},setPrevMsgNum:function(a){ha(this.$.prevMsgCount,a)},slideing:false,_slide:function(a){var b=this,d=b.prevCount,e=b.nextCount;if(e>0&&a==-1||d>0&&a==1){b.slideing=true;if(e==1&&a==-1||d==1&&a==1)b.slideing=false;b._slideSetup(false);b._setVisibleTabs(true);
if(a==-1){b.nextCount--;b.prevCount++}else if(a==1){b.nextCount++;b.prevCount--}var g=b.$.tabs,k=parseFloat(g.style.left);d=-1*b.tabWidth*b.nextCount;var m=parseInt(500/13),l=1,o=(d-k)/m,p=setInterval(function(){g.style.left=k+o*l+"px";if(l==m){if(b.slideing)b._slide(a);else{b._fitUI();b._slideReset()}clearInterval(p)}else l++},13)}},_slideUp:function(){this.slideing=false},_slideSetup:function(a){var b=this.$,d=b.tabsWrap;b=b.tabs;if(!this._tabsWidth)this._tabsWidth=b.clientWidth;if(a)this._tabsWidth=
null;d.style.position=a?"":"relative";d.style.overflow=a?"visible":"hidden";d.style.width=a?"":this._tabsWidth+"px";b.style.width=a?"":this.tabWidth*this.tabIds.length+"px";b.style.position=a?"":"relative"},_slideReset:function(){this._slideSetup(true)},_updateCount:function(){var a=this.maxVisibleTabs,b=this.tabIds.length,d=this.prevCount,e=this.nextCount;if(b<=a)d=e=0;else{e=b-a-d;e=e<0?0:e;d=b-a-e}this.prevCount=d;this.nextCount=e},_updateCountUI:function(){var a=this.$,b=this.prevCount,d=this.nextCount;
d<=0?G(a.next,"ui-state-disabled"):x(a.next,"ui-state-disabled");b<=0?G(a.prev,"ui-state-disabled"):x(a.prev,"ui-state-disabled");if(b>0||d>0){a.next.style.display="block";a.prev.style.display="block"}else{z(a.next);z(a.prev)}a.nextCount.innerHTML=d.toString();a.prevCount.innerHTML=b.toString()},_initEvents:function(){var a=this,b=a.$,d=false;r(a.window,"resize",function(){if(d){d=true;a.buildUI()}});r(b.next,"mousedown",function(){a._slide(-1)});r(b.next,"mouseup",function(){a._slideUp()});pa(b.next);
r(b.prev,"mousedown",function(){a._slide(1)});r(b.prev,"mouseup",function(){a._slideUp()});pa(b.prev);r(b.expand,"click",function(){if(!a.isMinimize())return false;a.expand();a.trigger("expand");return false});r(b.collapse,"click",function(){if(a.isMinimize())return false;a.collapse();a.trigger("collapse");return false});na(b.collapse,"ui-state-hover","ui-state-default");na(b.expand,"ui-state-hover","ui-state-default")},isMinimize:function(){return ba(this.$.layout,"webim-layout-minimize")},collapse:function(){this.isMinimize()||
G(this.$.layout,"webim-layout-minimize")},expand:function(){this.isMinimize()&&x(this.$.layout,"webim-layout-minimize")},_displayUpdate:function(){this._ready&&this.trigger("displayUpdate")},_fitUI:function(){this._updateCount();this.$.tabs.style.left=-1*this.tabWidth*this.nextCount+"px";this._updateCountUI();this._setVisibleTabs();this._displayUpdate()},_stickyWin:null,_widgetStateChange:function(a,b){b!="minimize"&&j(this.widgets,function(d,e){e.window!=a&&e.window.minimize()});this._displayUpdate()},
widget:function(a){return this.widgets[a]},addWidget:function(a,b,d,e){var g=this;b=i(b,{closeable:false,subHeader:a.header});var k=a.element;b=new B.window(null,b);b.html(k);g.$[e?e:"widgets"].insertBefore(b.element,d&&g.widgets[d]?g.widgets[d].window.element:null);a.window=b;b.bind("displayStateChange",function(m){g._widgetStateChange(this,m)});g.widgets[a.name]=a},focusChat:function(a,b){b=ga(a,b);var d=this.tabs[b],e=this.panels[b];d&&d.isMinimize()&&d.restore();e&&e.focus()},chat:function(a,
b){return this.panels[ga(a,b)]},updateChat:function(a,b){b=h(b);for(var d,e=b.length,g,k=0;k<e;k++){d=b[k];(g=this.panels[ga(a,d.id)])&&g.update(d)}},updateAllChat:function(){j(this.panels,function(a,b){b.update()})},_onChatClose:function(a){this.tabIds=n(this.tabIds,function(b){return b!=a});delete this.tabs[a];delete this.panels[a];this._changeActive(a,true);this._fitUI()},_onChatChange:function(a,b){if(b=="minimize"){this._changeActive(a,true);this._displayUpdate()}else{this._changeActive(a);this._fitUI()}},
_changeActive:function(a,b){var d=this.activeTabId;if(b)d==a&&(this.activeTabId=null);else{d&&d!=a&&this.tabs[d].minimize();this.activeTabId=a;this._updatePrevCount(a)}},addChat:function(a,b,d,e){var g=this,k=g.panels,m=b.id;m=ga(a,m);if(!k[m]){a=g.tabs[m]=(new B.window(null,i({isMinimize:g.activeTabId||!g.options.chatAutoPop,tabWidth:g.tabWidth-2,titleVisibleLength:9},e))).bind("close",function(){g._onChatClose(m)}).bind("displayStateChange",function(l){g._onChatChange(m,l)});g.tabIds.push(m);g.$.tabs.insertBefore(a.element,
g.$.tabs.firstChild);k[m]=new B.chat(null,i({window:a,user:g.options.user,info:b},d));!a.isMinimize()&&g._changeActive(m);g._fitUI()}},removeChat:function(a,b){var d=this.tabs[ga(a,b)];d&&d.close()},removeAllChat:function(){j(this.tabs,function(a,b){b.close()})},addShortcut:function(a){var b=this;if(ka(a))j(a,function(g,k){b.addShortcut(k)});else if(c(a)){var d=b.$.shortcut,e=b.options.tpl_shortcut;if(!(d.childNodes.length>b.options.shortcutLength+1)){e=J(H(e,{title:w(a.title),icon:a.icon,link:a.link,
target:a.isExtlink?"_blank":""}));na(e.firstChild,"ui-state-hover");d.appendChild(e)}}},addWindow:function(){new B.window(null,{})},online:function(){},offline:function(){}});M("history",{user:{},info:{},template:'<div class="webim-history">                        <div id=":content" class="webim-history-content">                 </div></div>'},{_init:function(){R.call(this,"init",[null,this.ui()])},clear:function(){this.$.content.innerHTML="";this.trigger("clear")},add:function(a){a=h(a);var b=a.length,
d=[];if(b){for(var e=0;e<b;e++)d.push(this._renderMsg(a[e]));this.$.content.innerHTML+=d.join("");this.trigger("update")}},_renderMsg:function(a){a=i({},a);R.call(this,"render",[null,this.ui({msg:a})]);var b=a.from,d=a.to,e=a.timestamp,g=a.body,k=true,m=this._lastLogItem,l=[],o;o=a.nick;if(m&&m.to==d&&m.from==b&&e-m.timestamp<6E4)k=false;if(k){this._lastLogItem=a;a=new V(e);l.push('<h4><span class="webim-gray">');l.push(a.getDay(true));l.push(" ");l.push(a.getTime());l.push("</span>");l.push(o);l.push('</h4><hr class="webim-line ui-state-default" />')}l.push("<p>");
l.push(g);l.push("</p>");return l.join("")},_renderDateBreak:function(a){var b=this._lastLogItem,d=new Date,e=new Date,g=[];d.setTime(a);b&&e.setTime(b.timestamp);if(!b||d.getDate()!=e.getDate()||d.getMonth()!=e.getMonth()){g.push("<h5>");g.push((new V(a)).getDay(true));g.push("</h5>")}return g.join("")},ui:function(a){return i({element:this.element,$:this.$},a)},plugins:{}});var za=function(){function a(e,g){return'<a href="'+(g=="www."?"http://"+e:e)+'"'+d+">"+e+"</a>"}function b(e,g){d+=" "+e+
'="'+g+'"'}var d;return function(e,g){d="";g&&c(g)&&j(g,b);return e.replace(/(https?:\/\/|www\.)([^\s<]+)/ig,a)}}();B.history.defaults.parseMsg=true;R.add("history","parseMsg",{render:function(a,b){var d=b.msg.body;d=aa(d);d=za(d,{target:"_blank"});b.msg.body=d}});B.history.defaults.emot=true;R.add("history","emot",{render:function(a,b){b.msg.body=B.emot.parse(b.msg.body)}});M("emot",{template:'<div class="webim-emot ui-widget-content"><%=emots%></div>'},{_init:function(){var a=this,b=a.element;j(b.firstChild.childNodes,
function(d,e){r(e,"click",function(){x(b,"webim-emot-show");a.trigger("select",this.firstChild.getAttribute("rel"))})})},template:function(){var a=this.emots=webim.ui.emot.emots,b=[];b.push('<ul class="ui-helper-clearfix">');j(a,function(d,e){var g=e.src,k=e.t?e.t:e.q[0];b.push('<li><img src="');b.push(g);b.push('" title="');b.push(k);b.push('" alt="');b.push(e.q[0]);b.push('" rel="');b.push(e.q[0]);b.push('" /></li>')});b.push("</ul>");return H(this.options.template,{emots:b.join("")})},toggle:function(){ta(this.element,
"webim-emot-show")}});i(B.emot,{emots:[{t:"smile",src:"smile.png",q:[":)"]},{t:"smile_big",src:"smile-big.png",q:[":d",":-d",":D",":-D"]},{t:"sad",src:"sad.png",q:[":(",":-("]},{t:"wink",src:"wink.png",q:[";)",";-)"]},{t:"tongue",src:"tongue.png",q:[":p",":-p",":P",":-P"]},{t:"shock",src:"shock.png",q:["=-O","=-o"]},{t:"kiss",src:"kiss.png",q:[":-*"]},{t:"glasses_cool",src:"glasses-cool.png",q:["8-)"]},{t:"embarrassed",src:"embarrassed.png",q:[":-["]},{t:"crying",src:"crying.png",q:[":'("]},{t:"thinking",
src:"thinking.png",q:[":-/",":-\\"]},{t:"angel",src:"angel.png",q:["O:-)","o:-)"]},{t:"shut_mouth",src:"shut-mouth.png",q:[":-X",":-x"]},{t:"moneymouth",src:"moneymouth.png",q:[":-$"]},{t:"foot_in_mouth",src:"foot-in-mouth.png",q:[":-!"]},{t:"shout",src:"shout.png",q:[">:o",">:O"]}],init:function(a){var b=webim.ui.emot,d=b._q={};a=i({dir:"webim/static/emot/default"},a);if(a.emots)b.emots=a.emots;var e=a.dir+"/";j(b.emots,function(g,k){if(k&&k.src)k.src=e+k.src;k&&k.q&&j(k.q,function(m,l){d[l]=g})})},
parse:function(a){var b=webim.ui.emot._q,d=webim.ui.emot.emots;b&&j(b,function(e,g){var k=d[g],m=k.src,l=k.t?k.t:k.q[0],o=[];o.push('<img src="');o.push(m);o.push('" title="');o.push(l);o.push('" alt="');o.push(k.q[0]);o.push('" />');e=aa(e);e=e.replace(RegExp("(\\"+".$^*\\[]()|+?{}:<>".split("").join("|\\")+")","g"),"\\$1");a=a.replace(RegExp(e,"g"),o.join(""))});return a}});M("chat",{tpl_header:'<div><div id=":user" class="webim-user"> \t\t\t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" src="" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t\t\t<span id=":userStatus" title="" class="webim-user-status">&nbsp;</span> \t\t     </div></div>',
template:'<div class="webim-chat"> \t\t\t\t<div class="webim-chat-notice-wrap"><div id=":notice" class="webim-chat-notice ui-state-highlight"></div></div>                                                 <div id=":content" class="webim-chat-content">                                                                                                                 <div id=":status" class="webim-chat-status webim-gray"></div>                                                 </div>                                                 <div id=":actions" class="webim-chat-actions">                                                         <div id=":toolContent" class="webim-chat-tool-content"></div>                                                        <div id=":tools" class="webim-chat-tools ui-helper-clearfix ui-state-default"></div>                                                        <table class="webim-chat-t" cellSpacing="0">                                                                 <tr>                                                                         <td style="vertical-align:top;">                                                                         <em class="webim-icon webim-icon-chat-edit"></em>                                                                        </td>                                                                         <td style="vertical-align:top;width:100%;">                                                                         <div class="webim-chat-input-wrap">                                                                                <textarea id=":input" class="webim-chat-input webim-gray ui-widget-content"><%=input notice%></textarea>                                                                         </div>                                                                         </td>                                                                 </tr>                                                         </table>                                                 </div>                                         </div>'},
{_init:function(){var a=this.element,b=this.options,d=this.window=b.window,e=this.history=new B.history(null,{user:b.user,info:b.info});this.$.content.insertBefore(e.element,this.$.content.firstChild);this.header=J(H(b.tpl_header));i(this.$,oa(this.header));if(d){d.subHeader(this.header);d.html(a);this._bindWindow()}b.simple&&z(this.header);this.update(b.info);e.add(b.history);R.call(this,"init",[null,this.ui()]);this._adjustContent()},update:function(a){if(a){this.option("info",a);this.history.option("info",
a);this._updateInfo(a)}a=this.options.info.presence=="online";if(this.options.user.presence=="online")a?this.notice(""):this.notice(w("buddy offline notice",{name:this.options.info.nick}));else this.notice(w("user offline notice"));R.call(this,"update",[null,this.ui()])},focus:function(){var a=this.$.input;v.setTimeout(function(){a.focus()},0)},_noticeTime:null,_noticeTxt:"",notice:function(a,b){var d=this,e=d.$.notice,g=d._noticeTime;g&&clearTimeout(g);if(a)if(b){e.innerHTML=a;F(e);setTimeout(function(){if(d._noticeTxt)e.innerHTML=
d._noticeTxt;else z(e,500)},b)}else{d._noticeTxt=a;e.innerHTML=a;F(e)}else{d._noticeTxt=null;z(e)}},_adjustContent:function(){var a=this.$.content;a.scrollTop=a.scrollHeight},_fitUI:function(){this._adjustContent()},_bindWindow:function(){var a=this;a.window.bind("displayStateChange",function(b){if(b!="minimize"){v.setTimeout(function(){a.$.input.focus()},0);a._adjustContent()}})},_inputAutoHeight:function(){var a=this.$.input,b=a[0].scrollTop;if(b>0){var d=a.height();d>32&&d<100&&a.height(d+b)}},
_sendMsg:function(a){var b=this.options,d=b.info;a={type:b.msgType,to:d.id,from:b.user.id,nick:b.user.nick,offline:d.presence!="online",timestamp:(new Date).getTime(),body:a};R.call(this,"send",[null,this.ui({msg:a})]);this.trigger("sendMsg",a)},_inputkeypress:function(a){if(a.keyCode==13)if(a.ctrlKey){this.insert("\n",true);return true}else{var b=U(a),d=b.value;if(f(d).length){this._sendMsg(d);b.value="";N(a)}}else this._typing()},_onFocusInput:function(a){var b=this;U(a);(v.getSelection?v.getSelection().toString():
t.selection?t.selection.createRange().text:"")||v.setTimeout(function(){b.$.input.focus()},0)},_initEvents:function(){var a=this,b=a.$,d=w("input notice"),e=b.input;a.history.bind("update",function(){a._adjustContent()}).bind("clear",function(){a.notice(w("clear history notice"),3E3)});r(e,"keyup",function(){va.call(this)});r(e,"click",va);r(e,"select",va);r(e,"focus",function(){x(this,"webim-gray");if(this.value==d)this.value=""});r(e,"blur",function(){if(this.value==""){G(this,"webim-gray");this.value=
d}});r(e,"keypress",function(g){a._inputkeypress(g)});r(b.content,"click",function(g){a._onFocusInput(g)})},_updateInfo:function(a){var b=this.$;b.userPic.setAttribute("href",a.url);b.userPic.firstChild.setAttribute("defaultsrc",a.default_pic_url?a.default_pic_url:"");setTimeout(function(){if(a.pic_url||a.default_pic_url)b.userPic.firstChild.setAttribute("src",a.pic_url||a.default_pic_url)},100);b.userStatus.innerHTML=ia(a.status)||"&nbsp";this.window.title(a.nick,a.show)},insert:function(a,b){var d=
this.$.input;d.focus();if(b){a||(a="");if(d.setSelectionRange){var e=d.value,g=d.selectionStart,k=d.selectionEnd,m=e.substring(0,g);e=e.substring(k);k=a.length;d.value=m+a+e;d.setSelectionRange(g+k,g+k)}else if(t.selection)if(g=d.caretPos){g.text=a;g.collapse();g.select()}else d.value+=a;else d.value+=a}else d.value=a},_statusText:"",sendStatus:function(a){if(!(!a||a==this._statusText||this.options.info.presence=="offline")){this._statusText=a;this.trigger("sendStatus",{to:this.options.info.id,show:a})}},
_checkST:false,_typing:function(){var a=this;a.sendStatus("typing");a._checkST&&clearTimeout(a._checkST);a._checkST=v.setTimeout(function(){a.sendStatus("clear")},6E3)},_setST:null,status:function(a){a=a||"clear";var b=this.$.status,d=this.options.info.nick,e="";e=a=="clear"?"":d+w(a);b.innerHTML=e;this._adjustContent();this._setST&&clearTimeout(this._setST);if(e!="")this._setST=v.setTimeout(function(){b.innerHTML=""},1E4)},destroy:function(){this.window.close()},ui:function(a){return i({self:this,
$:this.$,history:this.history},a)},plugins:{}});B.chat.defaults.emot=true;R.add("chat","emot",{init:function(a,b){var d=b.self,e=new B.emot;e.bind("select",function(k){d.focus();d.insert(k,true)});var g=J(H('<a href="#chat-emot" title="<%=emot%>"><em class="webim-icon webim-icon-emot"></em></a>'));r(g,"click",function(k){N(k);e.toggle()});b.$.toolContent.appendChild(e.element);b.$.tools.appendChild(g)},send:function(){}});B.chat.defaults.clearHistory=true;R.add("chat","clearHistory",{init:function(a,
b){var d=b.self,e=J(H('<a href="#chat-clearHistory" title="<%=clear history%>"><em class="webim-icon webim-icon-clear"></em></a>'));r(e,"click",function(g){N(g);d.trigger("clearHistory",[d.options.info])});b.$.tools.appendChild(e)}});B.chat.defaults.block=true;R.add("chat","block",{init:function(a,b){var d=b.self,e=d.options.info.blocked,g=d.options.info.nick,k=J('<a href="#chat-block" style="display:'+(e?"none":"")+'" title="'+w("block group",{name:g})+'"><em class="webim-icon webim-icon-unblock"></em></a>'),
m=J('<a href="#chat-block" style="display:'+(e?"":"none")+'" title="'+w("unblock group",{name:g})+'"><em class="webim-icon webim-icon-block"></em></a>');r(k,"click",function(l){N(l);z(k);F(m);d.trigger("block",[d.options.info])});r(m,"click",function(l){N(l);z(m);F(k);d.trigger("unblock",[d.options.info])});b.$.tools.appendChild(k);b.$.tools.appendChild(m)}});B.chat.defaults.member=true;i(B.chat.prototype,{addMember:function(a,b,d){var e=this,g=e.memberLi;if(!g[a]){var k=J('<li><a class="'+(d?"ui-state-disabled":
"")+'" href="'+a+'">'+b+"</a></li>");r(k.firstChild,"click",function(m){N(m);d||e.trigger("select",[{id:a,nick:b}])});g[a]=k;e.$.member.appendChild(k);e.$.memberCount.innerHTML=parseInt(e.$.memberCount.innerHTML)+1}},removeMember:function(a){var b=this.memberLi[a];if(b){this.$.member.removeChild(b);delete this.memberLi[a];this.$.memberCount.innerHTML=parseInt(this.$.memberCount.innerHTML)-1}}});R.add("chat","member",{init:function(a,b){var d=b.$;b.self.memberLi={};var e=J(H('<div class="webim-member ui-widget-content ui-corner-left"><iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><h4><%=room member%>(<span id=":memberCount">0</span>)</h4><ul id=":ul"></ul></div>')),
g=oa(e);d.member=g.ul;d.memberCount=g.memberCount;d.content.parentNode.insertBefore(e,d.content)}});Z("setting",{init:function(a){var b=this.im.setting,d=this.layout,e=this.setting=new B.setting(null,a);d.addWidget(e,{title:w("setting"),icon:"setting",sticky:false,onlyIcon:true,isMinimize:true});b.bind("update",function(g,k){typeof k!="object"&&e.check_tag(g,k)});e.bind("change",function(g,k){b.set(g,k)})},stop:function(){}});M("setting",{template:'<div id="webim-setting" class="webim-setting">\t\t\t<ul id=":ul"><%=tags%></ul>\t\t   </div>',
tpl_check:'<li id=":<%=name%>"><input type="checkbox" <%=checked%> id="webim-setting-<%=name%>" name="<%=name%>"/><label for="webim-setting-<%=name%>"><%=label%></label></li>'},{_init:function(){},template:function(){var a=this,b=[],d=a.options.data;d&&j(d,function(e,g){g&&typeof g!="boolean"||b.push(a._check_tpl(e,g))});return H(a.options.template,{tags:b.join("")})},_initEvents:function(){var a=this,b=a.options.data,d=a.$;b&&j(b,function(e){d[e]&&a._check_event(d[e])})},_check_tpl:function(a,b){return H(this.options.tpl_check,
{label:w(a),name:a,checked:b?'checked="checked"':""})},_check_event:function(a){var b=this;r(a.firstChild,"click",function(){b._change(this.name,this.checked)})},check_tag:function(a,b){var d=this;if(c(a))j(a,function(k,m){d.check_tag(k,m)});else{var e=d.$,g=e[a];if(!(b&&typeof b!="boolean"))if(g)g.firstChild.checked=b;else{g=e[a]=J(d._check_tpl(a,b));d._check_event(g);e.ul.appendChild(g)}}},_change:function(a,b){this.trigger("change",[a,b])},destroy:function(){}});Z("user",{init:function(a){a=a||
{};var b=this.im,d=this.user=new B.user;a.container&&a.container.appendChild(d.element);d.bind("online",function(e){b.online(e)}).bind("offline",function(){b.offline()}).bind("presence",function(e){b.sendPresence(e)});d.update(b.data.user)},ready:function(){},go:function(){this.user.update(this.im.data.user)},stop:function(){this.user.show("unavailable")}});M("user",{template:'<div>  \t\t<div id=":user" class="webim-user"> \t\t\t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t\t\t\t<div class="webim-user-show"><h4><a  id=":userShowTrigger" href="#show"><strong id=":userNick"></strong><span id=":userShow"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></span><em class="ui-icon ui-icon-triangle-1-s"><%=show_status_list%></em></a></h4>\t\t\t\t\t<p id=":userShowList" class="ui-state-active ui-corner-all" style="display: none;">\t\t\t\t\t\t<a href="#available" class="webim-user-show-available"><em class="webim-icon webim-icon-available"><%=available%></em><%=available%></a>\t\t\t\t\t\t<a href="#dnd" class="webim-user-show-dnd"><em class="webim-icon webim-icon-dnd"><%=dnd%></em><%=dnd%></a>\t\t\t\t\t\t<a href="#away" class="webim-user-show-away"><em class="webim-icon webim-icon-away"><%=away%></em><%=away%></a>\t\t\t\t\t\t<a href="#invisible" class="webim-user-show-invisible"><em class="webim-icon webim-icon-invisible"><%=invisible%></em><%=invisible%></a>\t\t\t\t\t\t<a href="#unavailable" class="webim-user-show-unavailable"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></a>\t\t\t\t\t</p>\t\t\t\t</div> \t\t\t\t\t<span id=":userStatus" title="" class="webim-user-status"></span> \t\t\t\t\t\t</div> \t\t\t\t\t\t\t</div>'},
{_init:function(){},_initEvents:function(){var a=this,b=a.$,d=b.userShowList;r(b.userShowTrigger,"click",function(e){d.style.display=="block"?z(d):F(d);N(e)});j(ma(d.firstChild),function(e,g){r(g,"click",function(k){a._set(this.href.split("#")[1]);z(d);N(k)})})},update:function(a){var b=a.show||"unavailable",d=this.$;this.options.info=a;d.userStatus.innerHTML=ia(a.status)||"&nbsp;";d.userNick.innerHTML=a.nick||"";d.userPic.setAttribute("href",a.url);d.userPic.firstChild.setAttribute("defaultsrc",
a.default_pic_url?a.default_pic_url:"");setTimeout(function(){if(a.pic_url||a.default_pic_url)d.userPic.firstChild.setAttribute("src",a.pic_url||a.default_pic_url)},100);this.show(b)},show:function(a){var b=w(a);this.$.userShow.innerHTML='<em class="webim-icon webim-icon-'+a+'">'+b+"</em>"+b},_set:function(a){var b=this.options.info;this.show(a);if(b){if(b.show!=a)if(a=="unavailable")this.trigger("offline",[]);else b.show=="unavailable"?this.trigger("online",[{show:a}]):this.trigger("presence",[{show:a,
status:b.status}])}else a!="unavailable"&&this.trigger("online",[{show:a}])},destroy:function(){}});Z("buddy",{init:function(a){a=a||{};var b=this,d=b.im,e=d.buddy,g=b.layout,k=b.buddy=new B.buddy(null,i({title:w("buddy")},a));g.addWidget(k,i({title:w("buddy"),icon:"buddy",sticky:d.setting.get("buddy_sticky"),className:"webim-buddy-window",isMinimize:!d.status.get("b"),titleVisibleLength:19},a.windowOptions));if(!a.disable_user){b.addApp("user");k.window.subHeader(b.user.element)}d.setting.bind("update",
function(p,y){p=="buddy_sticky"&&k.window.option("sticky",y)});k.bind("select",function(p){b.addChat("buddy",p.id);b.layout.focusChat("buddy",p.id)}).bind("online",function(){d.online()});k.window.bind("displayStateChange",function(p){if(p!="minimize"){e.option("active",true);d.status.set("b",1);e.complete()}else{d.status.set("b",0);e.option("active",false)}});var m=function(p){return c(p)?p.id:p},l=function(p){return p.show!="invisible"&&p.presence=="online"},o=function(p){return p.show=="invisible"};
e.bind("online",function(p){k.add(n(p,l))});e.bind("offline",function(p){k.remove(X(p,m))});e.bind("update",function(p){k.add(n(p,l));k.update(n(p,l));k.remove(X(n(p,o),m))});k.offline()},ready:function(){this.buddy.online()},go:function(){this.buddy.titleCount()},stop:function(a){var b=this.buddy;b.offline();a&&b.notice(a)}});M("buddy",{template:'<div id="webim-buddy" class="webim-buddy">\t\t<div id=":search" class="webim-buddy-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t\t\t<div class="webim-buddy-content">\t\t\t\t<div id=":empty" class="webim-buddy-empty"><%=empty buddy%></div>\t\t\t\t\t<ul id=":ul"></ul>\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>',
tpl_group:'<li><h4><%=title%>(<%=count%>)</h4><hr class="webim-line ui-state-default" /><ul></ul></li>',tpl_li:'<li title=""><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><em class="webim-icon webim-icon-<%=show%>" title="<%=human_show%>"><%=show%></em><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong><span><%=status%></span></a></li>'},{_init:function(){var a=
this.options;this.groups={};this.li={};this.li_group={};this.size=0;a.disable_group&&G(this.element,"webim-buddy-hidegroup");a.simple&&G(this.element,"webim-buddy-simple")},_initEvents:function(){var a=this,b=a.$,d=b.search,e=b.searchInput,g=w("search buddy");r(d.firstChild,"click",function(){e.focus()});e.value=g;r(e,"focus",function(){G(d,"ui-state-active");if(this.value==g)this.value=""});r(e,"blur",function(){x(d,"ui-state-active");if(this.value=="")this.value=g});r(e,"keyup",function(){var k=
this.value;j(a.li,function(m,l){k&&(l.text||l.innerHTML.replace(/<[^>]*>/g,"")).indexOf(k)==-1?z(l):F(l)})})},titleCount:function(){var a=this.size,b=this.window,d=this.$.empty;b&&b.title(this.options.title+"("+(a?a:"0")+")");a?z(d):F(d);a>8?this.scroll(true):this.scroll(false)},scroll:function(a){ta(this.element,"webim-buddy-scroll",a)},_time:null,_titleBuddyOnline:function(a){var b=this;a||(a="");b._time&&clearTimeout(b._time);b._time=setTimeout(function(){b.titleCount()},5E3)},_title:function(a){var b=
this.window;b&&b.title(this.options.title+"["+w(a)+"]")},notice:function(a,b){switch(a){case "buddyOnline":this._titleBuddyOnline(b);break;default:this._title(a)}},online:function(){var a=this.$;this.notice("connect");F(a.empty)},offline:function(){var a=this.$;this.notice("offline");F(a.empty);this.scroll(false);this.removeAll()},_updateInfo:function(a,b){a=a.firstChild;a.setAttribute("href",b.url);a=a.firstChild;var d=b.show?b.show:"available";a.className="webim-icon webim-icon-"+d;a.setAttribute("title",
w(d));a=a.nextSibling;a.setAttribute("defaultsrc",b.default_pic_url?b.default_pic_url:"");if(b.pic_url||b.default_pic_url)a.setAttribute("src",b.pic_url||b.default_pic_url);a=a.nextSibling;a.innerHTML=b.nick;a=a.nextSibling;a.innerHTML=ia(b.status)||"&nbsp;";return a},_addOne:function(a,b){var d=this,e=d.li,g=a.id,k=d.$.ul;if(!e[g]){d.size++;if(!a.default_pic_url)a.default_pic_url="";a.status=ia(a.status)||"&nbsp;";a.show=a.show||"available";a.human_show=w(a.show);a.pic_url=a.pic_url||"";e=e[g]=J(H(d.options.tpl_li,
a));r(e.firstChild,"click",function(o){N(o);d.trigger("select",[a]);this.blur()});var m=d.groups,l=w(a.group||"friend");m=m[l];if(!m){m=J(H(d.options.tpl_group));z(m);if(l==w("stranger"))b=true;b?k.appendChild(m):k.insertBefore(m,k.firstChild);m={name:l,el:m,count:0,title:m.firstChild,li:m.lastChild};d.groups[l]=m}m.count==0&&F(m.el);d.li_group[g]=m;m.li.appendChild(e);m.count++;m.title.innerHTML=l+"("+m.count+")"}},_updateOne:function(a){var b=this.li,d=a.id;b[d]&&this._updateInfo(b[d],a)},update:function(a){a=
h(a);for(var b=0;b<a.length;b++)this._updateOne(a[b])},add:function(a,b){a=h(a);for(var d=0;d<a.length;d++)this._addOne(a[d],b);this.titleCount()},removeAll:function(){var a=[],b=this.li;for(var d in b)a.push(d);this.remove(a);this.titleCount()},remove:function(a){var b,d,e=this.li,g,k=this.li_group;a=Y(a);for(var m=0;m<a.length;m++){b=a[m];if(d=e[b]){this.size--;if(g=k[b]){g.count--;g.count==0&&z(g.el);g.title.innerHTML=g.name+"("+g.count+")"}ja(d);delete e[b]}}this.titleCount()},select:function(a){(a=
this.li[a])&&a.firstChild.click();return a},destroy:function(){}});Z("room",{init:function(){function a(l){var o=l.nick;l=i({},l,{group:"group",nick:o+"("+(parseInt(l.count)+"/"+parseInt(l.all_count))+")"});k.updateChat(l);l.blocked&&(l.nick=o+"("+w("blocked")+")");m.li[l.id]?m.update(l):m.add(l)}var b=this,d=b.im,e=d.room,g=d.setting,k=b.layout,m=b.room=(new webim.ui.room(null)).bind("select",function(l){b.addChat("room",l.id);b.layout.focusChat("room",l.id)});k.addWidget(m,{title:w("room"),icon:"room",
sticky:d.setting.get("buddy_sticky"),onlyIcon:true,isMinimize:true},"notification");d.setting.bind("update",function(l,o){l=="buddy_sticky"&&m.window.option("sticky",o)});e.bind("join",function(l){a(l)}).bind("leave",function(){}).bind("block",function(l,o){g.set("blocked_rooms",o);a(e.get(l));e.leave(l)}).bind("unblock",function(l,o){g.set("blocked_rooms",o);a(e.get(l));e.join(l)}).bind("addMember",function(l){a(e.get(l))}).bind("removeMember",function(l){a(e.get(l))})},ready:function(){},go:function(){},
stop:function(){}});M("room",{template:'<div id="webim-room" class="webim-room">\t\t<div id=":search" class="webim-room-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t\t\t<div class="webim-room-content">\t\t\t\t<div id=":empty" class="webim-room-empty"><%=empty room%></div>\t\t\t\t\t<ul id=":ul"></ul>\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>',tpl_li:'<li title=""><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong></a></li>'},
{_init:function(){this.size=0;this.li={};this._count=0;F(this.$.empty)},_initEvents:function(){var a=this,b=a.$,d=b.search,e=b.searchInput,g=w("search room");r(d.firstChild,"click",function(){e.focus()});e.value=g;r(e,"focus",function(){G(d,"ui-state-active");if(this.value==g)this.value=""});r(e,"blur",function(){x(d,"ui-state-active");if(this.value=="")this.value=g});r(e,"keyup",function(){var k=this.value;j(a.li,function(m,l){k&&(l.text||l.innerHTML.replace(/<[^>]*>/g,"")).indexOf(k)==-1?z(l):F(l)})})},
scroll:function(a){ta(this.element,"webim-room-scroll",a)},_updateInfo:function(a,b){a=a.firstChild;a.setAttribute("href",b.url);a=a.firstChild;a.setAttribute("defaultsrc",b.default_pic_url?b.default_pic_url:"");a.setAttribute("src",b.pic_url);a=a.nextSibling;a.innerHTML=b.nick;return a},_addOne:function(a){var b=this,d=b.li,e=a.id,g=b.$.ul;b.size++;if(!d[e]){if(!a.default_pic_url)a.default_pic_url="";d=d[e]=J(H(b.options.tpl_li,a));r(d.firstChild,"click",function(k){N(k);b.trigger("select",[a]);
this.blur()});g.appendChild(d)}},_updateOne:function(a){var b=this.li,d=a.id;b[d]&&this._updateInfo(b[d],a)},update:function(a){a=h(a);for(var b=0;b<a.length;b++)this._updateOne(a[b])},add:function(a){z(this.$.empty);a=h(a);for(var b=0;b<a.length;b++)this._addOne(a[b]);this.size>8&&this.scroll(true)},removeAll:function(){var a=[],b=this.li;for(var d in b)a.push(d);this.remove(a)},remove:function(a){var b,d,e=this.li;a=Y(a);for(var g=0;g<a.length;g++){b=a[g];if(d=e[b]){ja(d);delete e[b]}}},select:function(a){(a=
this.li[a])&&a.firstChild.click();return a},destroy:function(){}});Z("menu",{init:function(a){var b=this.layout;a=this.menu=new B.menu(null,a);b.addWidget(a,{title:w("menu"),icon:"home",sticky:false,onlyIcon:false,isMinimize:true},null,"shortcut")}});M("menu",{template:'<div id="webim-menu" class="webim-menu">\t\t<ul id=":ul"><%=list%></ul>\t\t\t<div id=":empty" class="webim-menu-empty"><%=empty menu%></div>\t\t\t\t</div>',tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><img src="<%=icon%>"/><span><%=title%></span></a></li>'},
{_init:function(){var a=this.options;a.data&&a.data.length&&z(this.$.empty)},template:function(){var a=this,b=[],d=a.options.data;d&&j(d,function(e,g){b.push(a._li_tpl(g))});return H(a.options.template,{list:b.join("")})},_li_tpl:function(a){return H(this.options.tpl_li,{title:w(a.title),icon:a.icon,link:a.link,target:a.isExtlink?"_blank":""})},_fitUI:function(){var a=this.element;if(a.clientHeight>300)a.style.height="300px"},add:function(a){var b=this;if(ka(a))j(a,function(e,g){b.add(g)});else{var d=
b.$;z(d.empty);d.ul.appendChild(J(b._li_tpl(a)))}},destroy:function(){}});Z("chatlink",{init:function(a){var b=this,d=b.im,e=b.chatlink=(new webim.ui.chatlink(null,a)).bind("select",function(m){b.addChat("buddy",m);b.layout.focusChat("buddy",m)}),g=function(m){return m.show!="invisible"&&m.presence=="online"},k=function(m){return m.show=="invisible"};d.buddy.bind("online",function(m){e.add(n(m,g))}).bind("update",function(m){e.add(n(m,g));e.remove(n(m,k))}).bind("offline",function(m){e.remove(m)})},
ready:function(a){a.stranger_ids=this.chatlink.idsArray()},go:function(){this.chatlink.remove(this.im.data.user)},stop:function(){this.chatlink.removeAll()}});M("chatlink",{link_href:[/space\.php\?uid=(\d+)$/i,/space\-(\d+)\.html$/i,/space\-uid\-(\d+)\.html$/i,/\?mod=space&uid=(\d+)$/,/\?(\d+)$/],space_href:[/space\.php\?uid=(\d+)$/i,/space\-(\d+)\.html$/i,/space\-uid\-(\d+)\.html$/i,/\?mod=space&uid=(\d+)/,/\?(\d+)$/],space_class:/spacemenu_list|line_list|xl\sxl2\scl/i,space_id:/profile_act/i,off_link_class:null,
link_wrap:null,space_wrap:null},{_init:function(){function a(C,W){if(!C)return false;for(var la=W.length,qa=0;qa<la;qa++){var ya=W[qa].exec(C);if(ya&&ya[1])return ya[1]}return false}var b=this.list={},d=this.options,e=this.anthors={},g=d.link_href,k=d.space_href,m=d.space_id,l=d.off_link_class,o=d.space_class,p=d.space_wrap||t;(d=(d.link_wrap||t).getElementsByTagName("a"))&&j(d,function(C,W){var la=a(W.href,g),qa=W.innerHTML;if(la&&ma(W.firstChild).length==0&&qa&&(!W.className||!l||!l.test(W.className))){e[la]?
e[la].push(W):e[la]=[W];b[la]={id:la,name:qa}}});if(k=a(v.location.href,k)){b[k]=i(b[k],{id:k});p=p.getElementsByTagName("*");d=p.length;for(var y,L,O,P=0;P<d;P++){y=p[P];L=y.className;O=y.id;if(o&&o.test(L)||m&&m.test(O)){y=ma(y.firstChild);if(y.length){y=y[y.length-1];e[k]?e[k].push(y):e[k]=[y]}break}}}},_temp:function(a){var b=this;a=J(H('<a id="<%=id%>" href="#chat" title="<%=title%>" class="webim-chatlink"><%=text%></a>',a));r(a,"click",function(d){b.trigger("select",this.id);wa(d);N(d)});return a},
idsArray:function(){var a=[];j(this.list,function(b){a.push(b)});return a},add:function(a){var b=this.list,d=this.anthors,e=a.length,g,k,m,l,o;for(g=0;g<e;g++){k=a[g];if(k.id&&(m=k.uid)&&(l=b[m])){o=d[m];if(!l.elements&&o){l.elements=[];for(var p=0;p<o.length;p++)if(o[p].tagName.toLowerCase()=="li"){l.elements[p]=t.createElement("li");l.elements[p].appendChild(this._temp({id:k.id,title:"",text:w("chat with me")}))}else l.elements[p]=this._temp({id:k.id,title:w("chat with",{name:l.name}),text:""})}o&&
j(o,function(y,L){L.parentNode.insertBefore(l.elements[y],L.nextSibling)})}}},remove:function(a){var b=this.list,d=a.length,e,g,k,m;for(e=0;e<d;e++){g=a[e];if(g.id&&(k=g.uid)&&(m=b[k]))m.elements&&j(m.elements,function(l,o){ja(o)})}},removeAll:function(){j(this.list,function(a,b){b.elements&&j(b.elements,function(d,e){ja(e)})})}});q("notification",{url:"webim/notifications"},{_init:function(){this.request=this.options.jsonp?u:s},grep:function(a){return a&&a.text},handle:function(a){a=n(h(a),this.grep);
a.length&&this.trigger("data",[a])},load:function(){this.request({url:this.options.url,cache:false,dataType:"json",context:this,success:this.handle})}});Z("notification",{init:function(a){var b=this.im,d=this.layout,e=this.notification=new B.notification(null,a),g=b.notification=new webim.notification(null,{jsonp:b.options.jsonp});d.addWidget(e,{title:w("notification"),icon:"notification",sticky:false,onlyIcon:true,isMinimize:true});g.bind("data",function(k){e.window.notifyUser("information","+"+
k.length);e.add(k)});setTimeout(function(){g.load()},2E3)}});M("notification",{template:'<div id="webim-notification" class="webim-notification">\t\t<ul id=":ul"><%=list%></ul>\t\t\t<div id=":empty" class="webim-notification-empty"><%=empty notification%></div>\t\t\t\t</div>',tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><%=text%></a></li>'},{_init:function(){var a=this.options;a.data&&a.data.length&&z(this.$.empty)},template:function(){var a=this,b=[],d=a.options.data;d&&j(d,function(e,g){b.push(a._li_tpl(g))});
return H(a.options.template,{list:b.join("")})},_li_tpl:function(a){return H(this.options.tpl_li,{text:a.text,link:a.link,target:a.isExtlink?"_blank":""})},_fitUI:function(){var a=this.element;if(a.clientHeight>300)a.style.height="300px"},add:function(a){var b=this;if(ka(a))j(a,function(e,g){b.add(g)});else{var d=b.$;z(d.empty);d.ul.appendChild(J(b._li_tpl(a)))}},destroy:function(){}})})(window,document);
